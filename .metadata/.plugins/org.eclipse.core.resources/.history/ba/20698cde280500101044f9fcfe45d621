package com.care.boot.game;

import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.GameRequest;
import java.time.LocalDateTime;
import java.util.concurrent.ConcurrentHashMap;

@Controller
public class GameController {
    private final SimpMessagingTemplate messagingTemplate;
    private final GameService gameService;
    private final GameSessionManager sessionManager;

    private final ConcurrentHashMap<String, String> gameMoves = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<String, String> opponentMap = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<String, Integer> playerWins = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<String, Integer> gameCounts = new ConcurrentHashMap<>();

    public GameController(SimpMessagingTemplate messagingTemplate, GameService gameService, GameSessionManager sessionManager) {
        this.messagingTemplate = messagingTemplate;
        this.gameService = gameService;
        this.sessionManager = sessionManager;
    }

    @MessageMapping("/play")
    public void play(GameRequest request) {
        String playerId = request.getPlayerId();
        String move = request.getMove();
        String mode = request.getMode();

        System.out.println("ğŸ® í”Œë ˆì´ ìš”ì²­: " + playerId + " | ì„ íƒ: " + move + " | ëª¨ë“œ: " + mode);

        if ("server".equals(mode)) {
            processServerMode(playerId, move);
        } else {
            processPlayerMode(playerId, move);
        }
    }

    @MessageMapping("/match")
    public void handleMatchRequest(GameRequest request) {
        String playerId = request.getPlayerId();

        if (sessionManager.isInQueue(playerId)) {
            messagingTemplate.convertAndSend("/topic/match/" + playerId, "âŒ ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.");
            return;
        }

        String opponent = sessionManager.findMatch(playerId);
        if (opponent == null) {
            sessionManager.addToMatchQueue(playerId);
            messagingTemplate.convertAndSend("/topic/match/" + playerId, "âŒ ìƒëŒ€ ì—†ìŒ. ëŒ€ê¸° ì¤‘...");
            System.out.println("ğŸ• ëŒ€ê¸°ì—´ ì¶”ê°€ë¨: " + playerId);
        } else {
            opponentMap.put(playerId, opponent);
            opponentMap.put(opponent, playerId);
            messagingTemplate.convertAndSend("/topic/match/" + playerId, opponent);
            messagingTemplate.convertAndSend("/topic/match/" + opponent, playerId);
            System.out.println("âœ… ë§¤ì¹­ ì„±ê³µ: " + playerId + " vs " + opponent);
        }
    }

    private void processServerMode(String playerId, String move) {
        String serverMove = getRandomMove();
        String result = determineWinner(move, serverMove);

        GameDTO gameDTO = new GameDTO(0, playerId, "server", move, serverMove, result, LocalDateTime.now());
        gameService.saveGameResult(gameDTO);
        messagingTemplate.convertAndSend("/topic/result/" + playerId, gameDTO);
    }

    private void processPlayerMode(String playerId, String move) {
        if (!opponentMap.containsKey(playerId)) return;

        String opponent = opponentMap.get(playerId);
        gameMoves.put(playerId, move);

        if (!gameMoves.containsKey(opponent)) return;

        String opponentMove = gameMoves.remove(opponent);
        String result = determineWinner(move, opponentMove);
        String opponentResult = determineWinner(opponentMove, move);

        // âœ… ê° í”Œë ˆì´ì–´ì˜ ìŠ¹ë¦¬ íšŸìˆ˜ ë° ê²Œì„ íšŸìˆ˜ ì¦ê°€
        gameCounts.put(playerId, gameCounts.getOrDefault(playerId, 0) + 1);
        gameCounts.put(opponent, gameCounts.getOrDefault(opponent, 0) + 1);

        if (result.equals("ìŠ¹ë¦¬")) playerWins.put(playerId, playerWins.getOrDefault(playerId, 0) + 1);
        if (result.equals("íŒ¨ë°°")) playerWins.put(opponent, playerWins.getOrDefault(opponent, 0) + 1);

        // âœ… ê²Œì„ ê²°ê³¼ ì €ì¥
        GameDTO playerGame = new GameDTO(0, playerId, opponent, move, opponentMove, result, LocalDateTime.now());
        GameDTO opponentGame = new GameDTO(0, opponent, playerId, opponentMove, move, opponentResult, LocalDateTime.now());

        gameService.saveGameResult(playerGame);
        gameService.saveGameResult(opponentGame);

        messagingTemplate.convertAndSend("/topic/result/" + playerId, playerGame);
        messagingTemplate.convertAndSend("/topic/result/" + opponent, opponentGame);

        // âœ… 3ìŠ¹ì´ë©´ ì¦‰ì‹œ ì¢…ë£Œ & +5ì  ì¶”ê°€
        if (playerWins.getOrDefault(playerId, 0) == 3) {
            gameService.addBonusScore(playerId, 5);
            endGame(playerId, opponent);
            return;
        } else if (playerWins.getOrDefault(opponent, 0) == 3) {
            gameService.addBonusScore(opponent, 5);
            endGame(playerId, opponent);
        }
    }

    private void endGame(String player1, String player2) {
        playerWins.remove(player1);
        playerWins.remove(player2);
        gameCounts.remove(player1);
        gameCounts.remove(player2);
        opponentMap.remove(player1);
        opponentMap.remove(player2);
        messagingTemplate.convertAndSend("/topic/match/" + player1, "âœ… ê²Œì„ ì¢…ë£Œ! ìƒëŒ€ê°€ 3ìŠ¹ ë‹¬ì„±");
        messagingTemplate.convertAndSend("/topic/match/" + player2, "âœ… ê²Œì„ ì¢…ë£Œ! ìƒëŒ€ê°€ 3ìŠ¹ ë‹¬ì„±");
    }

    private String getRandomMove() {
        String[] moves = {"ê°€ìœ„", "ë°”ìœ„", "ë³´"};
        return moves[(int) (Math.random() * 3)];
    }

    private String determineWinner(String move1, String move2) {
        if (move1.equals(move2)) return "ë¬´ìŠ¹ë¶€";
        if ((move1.equals("ê°€ìœ„") && move2.equals("ë³´")) ||
            (move1.equals("ë°”ìœ„") && move2.equals("ê°€ìœ„")) ||
            (move1.equals("ë³´") && move2.equals("ë°”ìœ„"))) {
            return "ìŠ¹ë¦¬";
        }
        return "íŒ¨ë°°";
    }
}
