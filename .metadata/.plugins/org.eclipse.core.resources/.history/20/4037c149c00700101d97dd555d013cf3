package com.care.boot.game;

import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.PlayerStatsDTO;
import org.springframework.stereotype.Service;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Objects;

@Service
public class GameService {

    private final GameMapper gameMapper;

    public GameService(GameMapper gameMapper) {
        this.gameMapper = gameMapper;
    }

    public void saveGameResult(GameDTO playerGame, GameDTO opponentGame, boolean isMatchWin) {
        if (Objects.isNull(playerGame.getPlayDate())) {
            playerGame.setPlayDate(LocalDateTime.now());
        }
        if (Objects.isNull(opponentGame.getPlayDate())) {
            opponentGame.setPlayDate(LocalDateTime.now());
        }

        gameMapper.insertGameResult(playerGame);
        gameMapper.insertGameResult(opponentGame);

        int playerScoreChange = calculateScoreChange(playerGame.getResult(), isMatchWin);
        int opponentScoreChange = calculateScoreChange(opponentGame.getResult(), isMatchWin);

        // âœ… í•œ ë²ˆë§Œ ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤í–‰
        updatePlayerStats(playerGame.getPlayer1Id(), playerGame.getResult(), playerScoreChange);
        updatePlayerStats(opponentGame.getPlayer1Id(), opponentGame.getResult(), opponentScoreChange);
    }

    private int calculateScoreChange(String result, boolean isMatchWin) {
        int baseScore = switch (result) {
            case "ìŠ¹ë¦¬" -> 3;
            case "íŒ¨ë°°" -> -2;
            default -> 0;
        };

        // âœ… 3ì„ ìŠ¹ ë³´ë„ˆìŠ¤ë¥¼ ìŠ¹ë¦¬í•œ ì‚¬ëŒì—ê²Œë§Œ 1íšŒ ì ìš©
        if (isMatchWin && result.equals("ìŠ¹ë¦¬")) {
            return baseScore + 5;
        }
        return baseScore;
    }

    private void updatePlayerStats(String playerId, String result, int scoreChange) {
        if (!"server".equals(playerId)) {
            PlayerStatsDTO stats = gameMapper.getPlayerStats(playerId);

            // âœ… í”Œë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€ í›„ ì—…ë°ì´íŠ¸ ì§„í–‰
            if (stats == null) {
                gameMapper.createPlayerStats(playerId);
            }

            gameMapper.updatePlayerStats(playerId, result, scoreChange);
        }
    }

    public PlayerStatsDTO getPlayerStats(String playerId) {
        PlayerStatsDTO stats = gameMapper.getPlayerStats(playerId);
        if (stats != null) {
            stats.setKing(stats.getScore() >= 1000); // ğŸ‘‘ ì¡°ê±´ì— ë”°ë¼ isKing ì„¤ì •
        }
        return stats;
    }

    public List<PlayerStatsDTO> getRanking() {
        List<PlayerStatsDTO> list = gameMapper.getRanking();
        for (PlayerStatsDTO stats : list) {
            stats.setKing(stats.getScore() >= 1000); // ğŸ‘‘ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì™•ê´€ í‘œì‹œ
        }
        return list;
    }

    public List<GameDTO> getGameHistory(String playerId) {
        return gameMapper.getGameHistory(playerId);
    }

    public boolean deleteGameRecord(int gameId) {
        return gameMapper.deleteGameRecord(gameId) > 0;
    }

    private String getOppositeResult(String result) {
        return switch (result) {
            case "ìŠ¹ë¦¬" -> "íŒ¨ë°°";
            case "íŒ¨ë°°" -> "ìŠ¹ë¦¬";
            default -> "ë¬´ìŠ¹ë¶€";
        };
    }

    public int getPlayerScore(String playerId) {
        PlayerStatsDTO stats = gameMapper.getPlayerStats(playerId);
        return (stats != null) ? stats.getScore() : 0; // âœ… ì ìˆ˜ê°€ ì—†ìœ¼ë©´ 0 ë°˜í™˜
    }
}
