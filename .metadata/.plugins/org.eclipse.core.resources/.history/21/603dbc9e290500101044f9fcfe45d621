<script>
    var playerId = "<%= playerId %>";
    var opponent = null;
    var playerScore = 0;
    var playerWins = 0;
    var opponentWins = 0;
    var gameCount = 0;
    var seriesId = null; // âœ… ì‹œë¦¬ì¦ˆ ID ì¶”ê°€
    var socket = new SockJS('/game');
    var stompClient = Stomp.over(socket);

    stompClient.connect({}, function() {
        stompClient.subscribe('/topic/match/' + playerId, function(response) {
            opponent = response.body;
            if (opponent.startsWith('âŒ')) {
                document.getElementById("status").innerText = opponent;
            } else {
                document.getElementById("status").innerText = "ê²Œì„ ì‹œì‘! ìƒëŒ€: " + opponent;
                document.getElementById("opponent").innerText = opponent;
                enableGameButtons(true);
                seriesId = new Date().getTime().toString(); // âœ… ì‹œë¦¬ì¦ˆ ID ìƒì„±
            }
        });

        stompClient.subscribe('/topic/result/' + playerId, function(response) {
            var gameResult = JSON.parse(response.body);
            document.getElementById("result").innerText =
                "ë‚´ ì„ íƒ: " + gameResult.player1Move + 
                " | ìƒëŒ€ ì„ íƒ: " + gameResult.player2Move + 
                " | ê²°ê³¼: " + gameResult.result;

            if (opponent !== "server") {
                if (gameResult.result === "ìŠ¹ë¦¬") playerScore += 3;
                else if (gameResult.result === "íŒ¨ë°°") playerScore -= 2;
            }
            document.getElementById("playerScore").innerText = playerScore;

            if (playerScore >= 1000) document.getElementById("crown").style.display = 'inline';
            else document.getElementById("crown").style.display = 'none';

            gameCount++;
            if (gameResult.result === "ìŠ¹ë¦¬") playerWins++;
            else if (gameResult.result === "íŒ¨ë°°") opponentWins++;

            document.getElementById("playerWins").innerText = playerWins;
            document.getElementById("opponentWins").innerText = opponentWins;
            document.getElementById("gameCount").innerText = gameCount;

            if (playerWins === 3 || opponentWins === 3) {
                document.getElementById("status").innerText = "ğŸ‰ 3ìŠ¹ ë‹¬ì„±! ê²Œì„ ì¢…ë£Œ!";
                enableGameButtons(false);
                return;
            }

            document.getElementById("status").innerText = "ë‹¤ìŒ íŒì„ ì„ íƒí•˜ì„¸ìš”!";
            enableGameButtons(true);
        });
    });

    function sendMove(move) {
        var mode = document.getElementById("modeSelect").value;
        stompClient.send("/app/play", {}, JSON.stringify({ 
            playerId: playerId, 
            move: move, 
            mode: mode, 
            seriesId: seriesId // âœ… ì‹œë¦¬ì¦ˆ ID í¬í•¨
        }));
        document.getElementById("status").innerText = "ê²°ê³¼ ëŒ€ê¸° ì¤‘...";
    }
</script>
