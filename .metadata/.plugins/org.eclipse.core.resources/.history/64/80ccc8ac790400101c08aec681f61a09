package com.care.boot.game;

import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;
import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.PlayerStatsDTO;
import com.care.boot.gamedto.GameRequest;
import java.time.LocalDateTime;
import java.util.List;
import java.util.concurrent.ConcurrentHashMap;

@Controller
@RequestMapping("/game")
public class GameController {
    private final SimpMessagingTemplate messagingTemplate;
    private final GameService gameService;
    private final GameSessionManager sessionManager;

    // âœ… ìƒëŒ€ë°©ì˜ ì„ íƒì„ ì €ì¥í•  HashMap
    private final ConcurrentHashMap<String, String> gameMoves = new ConcurrentHashMap<>();

    public GameController(SimpMessagingTemplate messagingTemplate, GameService gameService, GameSessionManager sessionManager) {
        this.messagingTemplate = messagingTemplate;
        this.gameService = gameService;
        this.sessionManager = sessionManager;
    }

    // âœ… í”Œë ˆì´ ìš”ì²­ (ì„œë²„ ë˜ëŠ” í”Œë ˆì´ì–´ì™€ì˜ ëŒ€ê²°)
    @MessageMapping("/play")
    public void play(GameRequest request) {
        String playerId = request.getPlayerId();
        String move = request.getMove();
        String mode = (request.getMode() == null || request.getMode().isEmpty()) ? "server" : request.getMode();
        String opponent = request.getOpponent();

        if ("server".equals(mode)) {
            processServerMode(playerId, move);
        } else {
            processPlayerMode(playerId, move, opponent);
        }
    }

    // âœ… ì„œë²„ ëª¨ë“œ ì²˜ë¦¬
    private void processServerMode(String playerId, String move) {
        String serverMove = getRandomMove();
        String result = determineWinner(move, serverMove);

        GameDTO gameDTO = new GameDTO(0, playerId, "server", move, serverMove, result, LocalDateTime.now());
        gameService.saveGameResult(gameDTO);

        messagingTemplate.convertAndSend("/topic/result/" + playerId, gameDTO);
    }

    // âœ… í”Œë ˆì´ì–´ ëª¨ë“œ ì²˜ë¦¬ (ëœë¤ ë§¤ì¹­ í¬í•¨)
    private void processPlayerMode(String playerId, String move, String opponent) {
        synchronized (this) {  // ğŸ”¹ ë™ì‹œ ìš”ì²­ ë°©ì§€ (Race Condition í•´ê²°)
            if ("random".equals(opponent)) {
                opponent = sessionManager.findMatch(playerId);
            }

            if (opponent == null) {
                messagingTemplate.convertAndSend("/topic/match", "âŒ ìƒëŒ€ë°© ì—†ìŒ. ëŒ€ê¸° ì¤‘...");
                sessionManager.addToMatchQueue(playerId);
                return;
            }

            // ğŸ”¹ ìƒëŒ€ë°©ì´ ì˜¨ë¼ì¸ì¸ì§€ í™•ì¸ í›„ ê²Œì„ ì§„í–‰
            if (!sessionManager.isOnline(opponent)) {
                messagingTemplate.convertAndSend("/topic/match", "âŒ ìƒëŒ€ë°©ì´ ì˜¤í”„ë¼ì¸ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë§¤ì¹­í•˜ì„¸ìš”.");
                sessionManager.addToMatchQueue(playerId);
                return;
            }

            // âœ… ìƒëŒ€ë°©ì˜ ì„ íƒì„ ì €ì¥
            gameMoves.put(playerId, move);

            if (gameMoves.containsKey(opponent)) {
                String opponentMove = gameMoves.remove(opponent);
                String result = determineWinner(move, opponentMove);
                String opponentResult = determineWinner(opponentMove, move);

                GameDTO playerGame = new GameDTO(0, playerId, opponent, move, opponentMove, result, LocalDateTime.now());
                GameDTO opponentGame = new GameDTO(0, opponent, playerId, opponentMove, move, opponentResult, LocalDateTime.now());

                gameService.saveGameResult(playerGame);
                gameService.saveGameResult(opponentGame);

                messagingTemplate.convertAndSend("/topic/result/" + playerId, playerGame);
                messagingTemplate.convertAndSend("/topic/result/" + opponent, opponentGame);
            }
        }
    }


    // âœ… ëœë¤ ê°€ìœ„ë°”ìœ„ë³´ ì„ íƒ
    private String getRandomMove() {
        String[] moves = {"ê°€ìœ„", "ë°”ìœ„", "ë³´"};
        return moves[(int) (Math.random() * 3)];
    }

    // âœ… ìŠ¹íŒ¨ ê²°ì • ë¡œì§
    private String determineWinner(String move1, String move2) {
        if (move1.equals(move2)) return "ë¬´ìŠ¹ë¶€";
        if ((move1.equals("ê°€ìœ„") && move2.equals("ë³´")) ||
            (move1.equals("ë°”ìœ„") && move2.equals("ê°€ìœ„")) ||
            (move1.equals("ë³´") && move2.equals("ë°”ìœ„"))) {
            return "ìŠ¹ë¦¬";
        }
        return "íŒ¨ë°°";
    }
}
