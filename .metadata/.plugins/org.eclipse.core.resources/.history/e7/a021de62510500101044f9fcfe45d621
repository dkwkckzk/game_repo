package com.care.boot.game;

import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.PlayerStatsDTO;
import org.springframework.stereotype.Service;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

@Service
public class GameService {

    private final GameMapper gameMapper;

    public GameService(GameMapper gameMapper) {
        this.gameMapper = gameMapper;
    }

    // ğŸ”¹ ê²Œì„ ê²°ê³¼ ì €ì¥ (DBì— ê¸°ë¡)
    public void saveGameResult(GameDTO gameDTO, boolean isMatchWin) {
        if (Objects.isNull(gameDTO.getPlayDate())) {
            gameDTO.setPlayDate(LocalDateTime.now());
        }

        gameMapper.insertGameResult(gameDTO);

        int playerScore = calculateScore(gameDTO.getResult(), isMatchWin);
        int opponentScore = calculateScore(getOppositeResult(gameDTO.getResult()), isMatchWin);

        updatePlayerScore(gameDTO.getPlayer1Id(), playerScore);
        updatePlayerScore(gameDTO.getPlayer2Id(), opponentScore);
    }

    // ğŸ”¹ íŠ¹ì • í”Œë ˆì´ì–´ ì ìˆ˜ ì¡°íšŒ
    public PlayerStatsDTO getPlayerStats(String playerId) {
        return gameMapper.getPlayerStats(playerId);
    }

    // ğŸ”¹ ì „ì²´ ë­í‚¹ ì¡°íšŒ (ì ìˆ˜ ìˆœ ì •ë ¬)
    public List<PlayerStatsDTO> getRanking() {
        return gameMapper.getRanking();
    }

    // ğŸ”¹ íŠ¹ì • í”Œë ˆì´ì–´ì˜ ê²Œì„ ê¸°ë¡ ì¡°íšŒ
    public List<GameDTO> getGameHistory(String playerId) {
        return gameMapper.getGameHistory(playerId);
    }

    // ğŸ”¹ íŠ¹ì • ê²Œì„ ê¸°ë¡ ì‚­ì œ
    public boolean deleteGameRecord(int gameId) {
        return gameMapper.deleteGameRecord(gameId) > 0;
    }

    // ğŸ”¹ ì ìˆ˜ ì—…ë°ì´íŠ¸ (DB ë°˜ì˜)
    private void updatePlayerScore(String playerId, int scoreChange) {
        if (!"server".equals(playerId)) { 
            Optional.ofNullable(gameMapper.getPlayerStats(playerId)) 
                    .orElseGet(() -> {
                        gameMapper.createPlayerStats(playerId);
                        return gameMapper.getPlayerStats(playerId);
                    });

            gameMapper.updatePlayerScore(playerId, scoreChange);
        }
    }

    // ğŸ”¹ ì ìˆ˜ ê³„ì‚° ë¡œì§
    private int calculateScore(String result, boolean isMatchWin) {
        int score = switch (result) {
            case "ìŠ¹ë¦¬" -> 3;
            case "íŒ¨ë°°" -> -2;
            default -> 0;
        };

        // 3ì„ ìŠ¹ ë‹¬ì„± ì‹œ ì¶”ê°€ +5ì 
        return isMatchWin ? score + 5 : score;
    }

    // ğŸ”¹ ë°˜ëŒ€ ê²°ê³¼ ë°˜í™˜
    private String getOppositeResult(String result) {
        return switch (result) {
            case "ìŠ¹ë¦¬" -> "íŒ¨ë°°";
            case "íŒ¨ë°°" -> "ìŠ¹ë¦¬";
            default -> "ë¬´ìŠ¹ë¶€";
        };
    }
}
