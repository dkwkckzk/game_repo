package com.care.boot.game;

import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.GameRequest;
import java.time.LocalDateTime;
import java.util.concurrent.ConcurrentHashMap;

@Controller
public class GameMatchController {
    private final SimpMessagingTemplate messagingTemplate;
    private final GameService gameService;
    private final GameSessionManager sessionManager;

    // âœ… í”Œë ˆì´ì–´ ëŒ€ê²° ê´€ë ¨ ì •ë³´ ì €ì¥
    private final ConcurrentHashMap<String, String> opponentMap = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<String, Integer> playerWins = new ConcurrentHashMap<>();

    public GameMatchController(SimpMessagingTemplate messagingTemplate, GameService gameService, GameSessionManager sessionManager) {
        this.messagingTemplate = messagingTemplate;
        this.gameService = gameService;
        this.sessionManager = sessionManager;
    }

    /**
     * âœ… ëœë¤ ë§¤ì¹­ ìš”ì²­ ì²˜ë¦¬ (í”Œë ˆì´ì–´ vs í”Œë ˆì´ì–´)
     */
    @MessageMapping("/match")
    public void handleMatchRequest(GameRequest request) {
        String playerId = request.getPlayerId();

        // ì´ë¯¸ ëŒ€ê¸°ì—´ì— ìˆëŠ” ê²½ìš° ì¤‘ë³µ ë°©ì§€
        if (sessionManager.isInQueue(playerId)) {
            messagingTemplate.convertAndSend("/topic/match/" + playerId, "âŒ ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.");
            return;
        }

        // ëŒ€ê¸°ì—´ì—ì„œ ìƒëŒ€ ì°¾ê¸°
        String opponent = sessionManager.findMatch(playerId);
        if (opponent == null) {
            sessionManager.addToMatchQueue(playerId);
            messagingTemplate.convertAndSend("/topic/match/" + playerId, "âŒ ìƒëŒ€ ì—†ìŒ. ëŒ€ê¸° ì¤‘...");
        } else {
            // âœ… ë§¤ì¹­ ì„±ê³µ -> í”Œë ˆì´ì–´ ì €ì¥
            opponentMap.put(playerId, opponent);
            opponentMap.put(opponent, playerId);
            playerWins.put(playerId, 0);
            playerWins.put(opponent, 0);
            messagingTemplate.convertAndSend("/topic/match/" + playerId, opponent);
            messagingTemplate.convertAndSend("/topic/match/" + opponent, playerId);
        }
    }

    /**
     * âœ… í”Œë ˆì´ì–´ vs í”Œë ˆì´ì–´ ê°€ìœ„ë°”ìœ„ë³´ ì§„í–‰
     */
    @MessageMapping("/play")
    public void playMatch(GameRequest request) {
        String playerId = request.getPlayerId();
        String move = request.getMove();

        // ìƒëŒ€ ì •ë³´ í™•ì¸
        if (!opponentMap.containsKey(playerId)) return;

        String opponent = opponentMap.get(playerId);
        String opponentMove = getRandomMove();
        String result = determineWinner(move, opponentMove);

        // ìŠ¹ë¦¬ íšŸìˆ˜ ì¦ê°€
        if (result.equals("ìŠ¹ë¦¬")) playerWins.put(playerId, playerWins.getOrDefault(playerId, 0) + 1);
        if (result.equals("íŒ¨ë°°")) playerWins.put(opponent, playerWins.getOrDefault(opponent, 0) + 1);

        // 4ì„ ìŠ¹ì œ ì¢…ë£Œ ì²˜ë¦¬
        if (playerWins.get(playerId) == 4 || playerWins.get(opponent) == 4) {
            endGame(playerId, opponent);
        }
    }

    /**
     * âœ… 4ì„ ìŠ¹ ì‹œ ê²Œì„ ì¢…ë£Œ ë° ì¬ë§¤ì¹­
     */
    private void endGame(String winner, String loser) {
        opponentMap.remove(winner);
        opponentMap.remove(loser);
        messagingTemplate.convertAndSend("/topic/match/" + winner, "ğŸ‰ 4ì„ ìŠ¹ ì™„ë£Œ! ë‹¤ì‹œ ë§¤ì¹­ë©ë‹ˆë‹¤...");
        messagingTemplate.convertAndSend("/topic/match/" + loser, "âŒ ìƒëŒ€ê°€ 4ìŠ¹ ë‹¬ì„±! ë‹¤ì‹œ ë§¤ì¹­ë©ë‹ˆë‹¤...");
        sessionManager.addToMatchQueue(winner);
        sessionManager.addToMatchQueue(loser);
        handleMatchRequest(new GameRequest(winner));
        handleMatchRequest(new GameRequest(loser));
    }

    /**
     * âœ… ëœë¤ ê°€ìœ„ë°”ìœ„ë³´ ì„ íƒ
     */
    private String getRandomMove() {
        String[] moves = {"ê°€ìœ„", "ë°”ìœ„", "ë³´"};
        return moves[(int) (Math.random() * 3)];
    }

    /**
     * âœ… ìŠ¹ì íŒë³„ ë¡œì§
     */
    private String determineWinner(String move1, String move2) {
        if (move1.equals(move2)) return "ë¬´ìŠ¹ë¶€";
        if ((move1.equals("ê°€ìœ„") && move2.equals("ë³´")) ||
            (move1.equals("ë°”ìœ„") && move2.equals("ê°€ìœ„")) ||
            (move1.equals("ë³´") && move2.equals("ë°”ìœ„"))) {
            return "ìŠ¹ë¦¬";
        }
        return "íŒ¨ë°°";
    }
}
