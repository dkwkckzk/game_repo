<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.care.boot.game.GameMapper">

    <!-- üîπ Í≤åÏûÑ Í≤∞Í≥º Ï†ÄÏû• -->
    <insert id="insertGameResult">
        INSERT INTO game_history (player1_id, player2_id, player1_move, player2_move, result, play_date)
        VALUES (#{player1Id}, #{player2Id}, #{player1Move}, #{player2Move}, #{result}, NOW());
    </insert>

    <!-- üîπ ÌäπÏ†ï ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï†ÑÏ†Å Ï°∞Ìöå -->
    <select id="getPlayerStats" resultType="com.care.boot.gamedto.PlayerStatsDTO">
        SELECT id, total_games, wins, losses, draws, score,
               CASE WHEN total_games > 0 THEN (wins * 100.0 / total_games) ELSE 0 END AS win_rate
        FROM player_stats
        WHERE id = #{playerId};
    </select>

    <!-- üîπ ÏÉàÎ°úÏö¥ ÌîåÎ†àÏù¥Ïñ¥ Ï†ÑÏ†Å Ï∂îÍ∞Ä (Ï¥àÍ∏∞Ìôî) -->
    <insert id="createPlayerStats">
        INSERT INTO player_stats (id, total_games, wins, losses, draws, score)
        VALUES (#{playerId}, 0, 0, 0, 0, 0);
    </insert>

    <!-- üîπ Í≤åÏûÑ Í≤∞Í≥ºÏóê Îî∞Îùº Ï†ÑÏ†Å Î∞è Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏ -->
    <update id="updatePlayerStats">
        /* ‚úÖ ÏùåÏàò Ï†êÏàò Î∞©ÏßÄ (SQL Ï£ºÏÑù ÏÇ¨Ïö©) */
        UPDATE player_stats
        SET total_games = total_games + 1,
            wins = wins + CASE WHEN #{result} = 'ÏäπÎ¶¨' THEN 1 ELSE 0 END,
            losses = losses + CASE WHEN #{result} = 'Ìå®Î∞∞' THEN 1 ELSE 0 END,
            draws = draws + CASE WHEN #{result} = 'Î¨¥ÏäπÎ∂Ä' THEN 1 ELSE 0 END,
            score = CASE 
                WHEN (score + #{scoreChange}) < 0 THEN 0  /* ‚úÖ ÏùåÏàò Ï†êÏàò Î∞©ÏßÄ */
                ELSE score + #{scoreChange}
            END
        WHERE id = #{playerId};
    </update>

    <!-- üîπ Ï†ÑÏ≤¥ Îû≠ÌÇπ Ï°∞Ìöå (Ï†êÏàò Ïàú Ï†ïÎ†¨) -->
    <select id="getRanking" resultType="com.care.boot.gamedto.PlayerStatsDTO">
        SELECT id, total_games, wins, losses, draws, score,
               CASE WHEN total_games > 0 THEN (wins * 100.0 / total_games) ELSE 0 END AS win_rate
        FROM player_stats
        ORDER BY score DESC, wins DESC, win_rate DESC;
    </select>

</mapper>
