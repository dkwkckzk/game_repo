package com.care.boot.game;

import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.GameRequest;

@Controller
public class GameController {
    private final SimpMessagingTemplate messagingTemplate;

    public GameController(SimpMessagingTemplate messagingTemplate) {
        this.messagingTemplate = messagingTemplate;
    }

    @MessageMapping("/play") // âœ… í´ë¼ì´ì–¸íŠ¸ê°€ "/app/play"ë¡œ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬
    public void play(GameRequest request) {
        String playerId = request.getPlayerId();
        String move = request.getMove();

        System.out.println("ğŸ® í”Œë ˆì´ì–´: " + playerId + ", ì„ íƒ: " + move); // âœ… ìš”ì²­ ë¡œê·¸ ì¶”ê°€

        String serverMove = getRandomMove();
        String result = determineWinner(move, serverMove);

        // âœ… ì„œë²„ì—ì„œ ê²°ê³¼ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡
        messagingTemplate.convertAndSend("/topic/result/" + playerId, 
            new GameDTO(playerId, move, "ì„œë²„", serverMove, result, null));
    }

    private String getRandomMove() {
        String[] moves = {"ê°€ìœ„", "ë°”ìœ„", "ë³´"};
        return moves[(int) (Math.random() * 3)];
    }

    private String determineWinner(String move1, String move2) {
        if (move1.equals(move2)) return "ë¬´ìŠ¹ë¶€";
        if ((move1.equals("ê°€ìœ„") && move2.equals("ë³´")) ||
            (move1.equals("ë°”ìœ„") && move2.equals("ê°€ìœ„")) ||
            (move1.equals("ë³´") && move2.equals("ë°”ìœ„"))) {
            return "ìŠ¹ë¦¬";
        }
        return "íŒ¨ë°°";
    }
}
