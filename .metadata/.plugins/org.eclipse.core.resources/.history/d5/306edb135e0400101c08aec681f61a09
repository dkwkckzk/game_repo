package com.care.boot.game;

import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;
import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.PlayerStatsDTO;
import com.care.boot.gamedto.GameRequest;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.time.LocalDateTime;
import java.util.List;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentLinkedQueue;

@Controller
@RequestMapping("/game")
public class GameController {
    private final SimpMessagingTemplate messagingTemplate;
    private final GameService gameService;
    private final GameSessionManager sessionManager; // âœ… ì˜¨ë¼ì¸ ì‚¬ìš©ì ê´€ë¦¬
    private final ConcurrentLinkedQueue<String> waitingPlayers = new ConcurrentLinkedQueue<>();
    private final ConcurrentHashMap<String, String> gameMoves = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<String, String> opponentMap = new ConcurrentHashMap<>();

    public GameController(SimpMessagingTemplate messagingTemplate, GameService gameService, GameSessionManager sessionManager) {
        this.messagingTemplate = messagingTemplate;
        this.gameService = gameService;
        this.sessionManager = sessionManager;
    }

    // ğŸ”¹ WebSocketì„ ì´ìš©í•œ ê²Œì„ í”Œë ˆì´ ìš”ì²­ ì²˜ë¦¬
    @MessageMapping("/play")
    public void play(GameRequest request) {
        String playerId = request.getPlayerId();
        String move = request.getMove();
        String mode = (request.getMode() == null || request.getMode().isEmpty()) ? "server" : request.getMode();
        String opponent = request.getOpponent();

        if ("server".equals(mode)) {
            processServerMode(playerId, move);
        } else {
            processPlayerMode(playerId, move, opponent);
        }
    }

    // âœ… ì„œë²„ì™€ í”Œë ˆì´í•˜ëŠ” ëª¨ë“œ (ì»´í“¨í„°ì™€ ëŒ€ê²°)
    private void processServerMode(String playerId, String move) {
        String serverMove = getRandomMove();
        String result = determineWinner(move, serverMove);

        System.out.println("ğŸ“¢ ì„œë²„ ëª¨ë“œ ì§„í–‰: playerId=" + playerId + ", playerMove=" + move + ", serverMove=" + serverMove + ", result=" + result);

        GameDTO gameDTO = new GameDTO(0, playerId, "server", move, serverMove, result, LocalDateTime.now());
        System.out.println("âœ… GameDTO ìƒì„±ë¨: " + gameDTO);

        gameService.saveGameResult(gameDTO);

        // âœ… JSON ë³€í™˜ í™•ì¸
        ObjectMapper objectMapper = new ObjectMapper();
        try {
            String json = objectMapper.writeValueAsString(gameDTO);
            System.out.println("ğŸ“© í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ì†¡í•  JSON: " + json);
        } catch (JsonProcessingException e) {
            e.printStackTrace();
        }

        messagingTemplate.convertAndSend("/topic/result/" + playerId, gameDTO);
    }

    // âœ… í”Œë ˆì´ì–´ ëª¨ë“œ ì²˜ë¦¬ (ë©€í‹°í”Œë ˆì´ ë§¤ì¹­)
    private
