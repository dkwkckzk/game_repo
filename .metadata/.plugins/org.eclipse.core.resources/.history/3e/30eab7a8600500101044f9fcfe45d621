//package com.care.boot.game;
//
//import org.springframework.messaging.handler.annotation.MessageMapping;
//import org.springframework.messaging.simp.SimpMessagingTemplate;
//import org.springframework.stereotype.Controller;
//import com.care.boot.gamedto.GameDTO;
//import com.care.boot.gamedto.GameRequest;
//import java.time.LocalDateTime;
//import java.util.concurrent.ConcurrentHashMap;
//
//@Controller
//public class GameController {
//    private final SimpMessagingTemplate messagingTemplate;
//    private final GameService gameService;
//    private final GameSessionManager sessionManager;
//    
//    private final ConcurrentHashMap<String, String> gameMoves = new ConcurrentHashMap<>();
//    private final ConcurrentHashMap<String, String> opponentMap = new ConcurrentHashMap<>();
//    private final ConcurrentHashMap<String, Integer> playerWins = new ConcurrentHashMap<>();
//    private final ConcurrentHashMap<String, Boolean> isServerMode = new ConcurrentHashMap<>(); // âœ… ì„œë²„ ëª¨ë“œ ì—¬ë¶€ ì €ì¥
//
//    public GameController(SimpMessagingTemplate messagingTemplate, GameService gameService, GameSessionManager sessionManager) {
//        this.messagingTemplate = messagingTemplate;
//        this.gameService = gameService;
//        this.sessionManager = sessionManager;
//    }
//
//    @MessageMapping("/play")
//    public void play(GameRequest request) {
//        String playerId = request.getPlayerId();
//        String move = request.getMove();
//        String mode = request.getMode();
//
//        System.out.println("ğŸ® í”Œë ˆì´ ìš”ì²­: " + playerId + " | ì„ íƒ: " + move + " | ëª¨ë“œ: " + mode);
//
//        if ("server".equals(mode)) {
//            processServerMode(playerId, move);
//        } else {
//            processPlayerMode(playerId, move);
//        }
//    }
//
//    private void processServerMode(String playerId, String move) {
//        if (!opponentMap.containsKey(playerId) || !isServerMode.getOrDefault(playerId, false)) {
//            System.out.println("âš  " + playerId + "ëŠ” í˜„ì¬ ì„œë²„ì™€ ëŒ€ê²° ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.");
//            return;
//        }
//
//        String serverMove = getRandomMove();
//        String result = determineWinner(move, serverMove);
//
//        GameDTO gameDTO = new GameDTO(0, playerId, "server", move, serverMove, result, LocalDateTime.now());
//        gameService.saveGameResult(gameDTO);
//        messagingTemplate.convertAndSend("/topic/result/" + playerId, gameDTO);
//
//        // âœ… ì„œë²„ ëŒ€ê²°ì—ì„œëŠ” ê³„ì† ë²„íŠ¼ í™œì„±í™”
//        messagingTemplate.convertAndSend("/topic/continue/" + playerId, "ê³„ì† ì§„í–‰");
//    }
//
//    @MessageMapping("/startServerMatch")
//    public void startServerMatch(GameRequest request) {
//        String playerId = request.getPlayerId();
//        opponentMap.put(playerId, "server");
//        isServerMode.put(playerId, true); // âœ… ì„œë²„ ëª¨ë“œ í™œì„±í™”
//        messagingTemplate.convertAndSend("/topic/match/" + playerId, "server");
//        System.out.println("ğŸš€ ì„œë²„ì™€ì˜ ëŒ€ê²° ì‹œì‘: " + playerId);
//    }
//
//    @MessageMapping("/quitServerMatch")
//    public void quitServerMatch(GameRequest request) {
//        String playerId = request.getPlayerId();
//        opponentMap.remove(playerId);
//        isServerMode.remove(playerId); // âœ… ì„œë²„ ëª¨ë“œ í•´ì œ
//        messagingTemplate.convertAndSend("/topic/match/end/" + playerId, "âŒ ì„œë²„ ëŒ€ê²° ì¢…ë£Œë¨");
//        System.out.println("ğŸšª ì„œë²„ì™€ì˜ ëŒ€ê²° ì¢…ë£Œ: " + playerId);
//    }
//
//    @MessageMapping("/match")
//    public void handleMatchRequest(GameRequest request) {
//        String playerId = request.getPlayerId();
//
//        if (sessionManager.isInQueue(playerId)) {
//            messagingTemplate.convertAndSend("/topic/match/" + playerId, "âŒ ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.");
//            return;
//        }
//
//        String opponent = sessionManager.findMatch(playerId);
//        if (opponent == null) {
//            sessionManager.addToMatchQueue(playerId);
//            messagingTemplate.convertAndSend("/topic/match/" + playerId, "âŒ ìƒëŒ€ ì—†ìŒ. ëŒ€ê¸° ì¤‘...");
//            System.out.println("ğŸ• ëŒ€ê¸°ì—´ ì¶”ê°€ë¨: " + playerId);
//        } else {
//            opponentMap.put(playerId, opponent);
//            opponentMap.put(opponent, playerId);
//            playerWins.put(playerId, 0);
//            playerWins.put(opponent, 0);
//            messagingTemplate.convertAndSend("/topic/match/" + playerId, opponent);
//            messagingTemplate.convertAndSend("/topic/match/" + opponent, playerId);
//            System.out.println("âœ… ë§¤ì¹­ ì„±ê³µ: " + playerId + " vs " + opponent);
//        }
//    }
//
//    private void processPlayerMode(String playerId, String move) {
//        if (!opponentMap.containsKey(playerId)) return;
//
//        String opponent = opponentMap.get(playerId);
//        gameMoves.put(playerId, move);
//
//        if (!gameMoves.containsKey(opponent)) return;
//
//        String opponentMove = gameMoves.remove(opponent);
//        String result = determineWinner(move, opponentMove);
//        String opponentResult = determineWinner(opponentMove, move);
//
//        if (result.equals("ìŠ¹ë¦¬")) playerWins.put(playerId, playerWins.get(playerId) + 1);
//        if (result.equals("íŒ¨ë°°")) playerWins.put(opponent, playerWins.get(opponent) + 1);
//
//        GameDTO playerGame = new GameDTO(0, playerId, opponent, move, opponentMove, result, LocalDateTime.now());
//        GameDTO opponentGame = new GameDTO(0, opponent, playerId, opponentMove, move, opponentResult, LocalDateTime.now());
//
//        gameService.saveGameResult(playerGame);
//        gameService.saveGameResult(opponentGame);
//
//        messagingTemplate.convertAndSend("/topic/result/" + playerId, playerGame);
//        messagingTemplate.convertAndSend("/topic/result/" + opponent, opponentGame);
//
//        if (playerWins.get(playerId) == 4) {
//            endGame(playerId, opponent);
//        } else if (playerWins.get(opponent) == 4) {
//            endGame(opponent, playerId);
//        }
//    }
//
//    private void endGame(String winner, String loser) {
//        playerWins.remove(winner);
//        playerWins.remove(loser);
//        opponentMap.remove(winner);
//        opponentMap.remove(loser);
//        messagingTemplate.convertAndSend("/topic/match/" + winner, "ğŸ‰ 4ì„ ìŠ¹ ì™„ë£Œ! ê²Œì„ ì¢…ë£Œ!");
//        messagingTemplate.convertAndSend("/topic/match/" + loser, "âŒ ìƒëŒ€ê°€ 4ìŠ¹ ë‹¬ì„±! ê²Œì„ ì¢…ë£Œ!");
//        System.out.println("âœ… 4ì„ ìŠ¹ ì™„ë£Œ í›„ ë°ì´í„° ì‚­ì œ: " + winner + " vs " + loser);
//    }
//
//    private String getRandomMove() {
//        String[] moves = {"ê°€ìœ„", "ë°”ìœ„", "ë³´"};
//        return moves[(int) (Math.random() * 3)];
//    }
//
//    private String determineWinner(String move1, String move2) {
//        if (move1.equals(move2)) return "ë¬´ìŠ¹ë¶€";
//        if ((move1.equals("ê°€ìœ„") && move2.equals("ë³´")) ||
//            (move1.equals("ë°”ìœ„") && move2.equals("ê°€ìœ„")) ||
//            (move1.equals("ë³´") && move2.equals("ë°”ìœ„"))) {
//            return "ìŠ¹ë¦¬";
//        }
//        return "íŒ¨ë°°";
//    }
//}

package com.care.boot.game;

import com.care.boot.gamedto.PlayerStatsDTO;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api")
public class GameController {
    private final GameService gameService;

    public GameController(GameService gameService) {
        this.gameService = gameService;
    }

    // âœ… í”Œë ˆì´ì–´ì˜ í˜„ì¬ ì ìˆ˜ ì¡°íšŒ API
    @GetMapping("/player-score")
    public PlayerStatsDTO getPlayerScore(@RequestParam String playerId) {
        return gameService.getPlayerStats(playerId);
    }
}

