<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.care.boot.game.GameMapper">

    <!-- ðŸ”¹ ê²Œìž„ ê²°ê³¼ ì €ìž¥ -->
    <insert id="insertGameResult">
        INSERT INTO game_history (player1_id, player2_id, player1_move, player2_move, result, play_date)
        VALUES (#{player1Id}, #{player2Id}, #{player1Move}, #{player2Move}, #{result}, NOW());
    </insert>

    <!-- ðŸ”¹ íŠ¹ì • í”Œë ˆì´ì–´ì˜ ì „ì  ì¡°íšŒ -->
    <select id="getPlayerStats" resultType="com.care.boot.gamedto.PlayerStatsDTO">
        SELECT id, total_games, wins, losses, draws, score,
               CASE WHEN total_games > 0 THEN (wins * 100.0 / total_games) ELSE 0 END AS win_rate
        FROM player_stats
        WHERE id = #{playerId};
    </select>

    <!-- ðŸ”¹ ìƒˆë¡œìš´ í”Œë ˆì´ì–´ ì „ì  ì¶”ê°€ (ì´ˆê¸°í™”) -->
    <insert id="createPlayerStats">
        INSERT INTO player_stats (id, total_games, wins, losses, draws, score)
        VALUES (#{playerId}, 0, 0, 0, 0, 0);
    </insert>

    <!-- ðŸ”¹ ê²Œìž„ ê²°ê³¼ì— ë”°ë¼ ì „ì  ë° ì ìˆ˜ ì—…ë°ì´íŠ¸ -->
    <update id="updatePlayerStats">
	    UPDATE player_stats
	    SET total_games = total_games + 1,
	        wins = wins + CASE WHEN #{result} = 'ìŠ¹ë¦¬' THEN 1 ELSE 0 END,
	        losses = losses + CASE WHEN #{result} = 'íŒ¨ë°°' THEN 1 ELSE 0 END,
	        draws = draws + CASE WHEN #{result} = 'ë¬´ìŠ¹ë¶€' THEN 1 ELSE 0 END,
	        score = CASE 
	            WHEN score + #{scoreChange} < 0 THEN 0  <!-- âœ… ìŒìˆ˜ ë°©ì§€ -->
	            ELSE score + #{scoreChange}
	        END
	    WHERE id = #{playerId};
	</update>


    <!-- ðŸ”¹ ì „ì²´ ëž­í‚¹ ì¡°íšŒ (ì ìˆ˜ ìˆœ ì •ë ¬) -->
    <select id="getRanking" resultType="com.care.boot.gamedto.PlayerStatsDTO">
        SELECT id, total_games, wins, losses, draws, score,
               CASE WHEN total_games > 0 THEN (wins * 100.0 / total_games) ELSE 0 END AS win_rate
        FROM player_stats
        ORDER BY score DESC, wins DESC, win_rate DESC;
    </select>

</mapper>
