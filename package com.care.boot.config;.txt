package com.care.boot.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/topic");  // âœ… í´ë¼ì´ì–¸íŠ¸ê°€ ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œ ì‚¬ìš©í•˜ëŠ” prefix
        config.setApplicationDestinationPrefixes("/app"); // âœ… í´ë¼ì´ì–¸íŠ¸ê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” prefix
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/game")
                .setAllowedOriginPatterns("*")  // âœ… ì™€ì¼ë“œì¹´ë“œ ì‚¬ìš© ê°€ëŠ¥
                .withSockJS();
    }

}

package com.care.boot.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class JacksonConfig {
    @Bean
    public ObjectMapper objectMapper() {
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.registerModule(new JavaTimeModule());  // âœ… Java 8 ë‚ ì§œ ì§ë ¬í™” ëª¨ë“ˆ ì¶”ê°€
        return objectMapper;
    }
}




package com.care.boot.game;

import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.GameRequest;
import java.time.LocalDateTime;
import java.util.concurrent.ConcurrentHashMap;

@Controller
public class GameController {
    private final SimpMessagingTemplate messagingTemplate;
    private final GameService gameService;
    private final GameSessionManager sessionManager;
    private final ConcurrentHashMap<String, String> gameMoves = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<String, String> opponentMap = new ConcurrentHashMap<>();

    public GameController(SimpMessagingTemplate messagingTemplate, GameService gameService, GameSessionManager sessionManager) {
        this.messagingTemplate = messagingTemplate;
        this.gameService = gameService;
        this.sessionManager = sessionManager;
    }

    @MessageMapping("/play")
    public void play(GameRequest request) {
        String playerId = request.getPlayerId();
        String move = request.getMove();
        String mode = request.getMode();

        System.out.println("ğŸ® í”Œë ˆì´ ìš”ì²­: " + playerId + " | ì„ íƒ: " + move + " | ëª¨ë“œ: " + mode);

        // âœ… ì´ì „ ê²Œì„ ë°ì´í„° ì •ë¦¬
        gameMoves.remove(playerId);

        if ("server".equals(mode)) {
            processServerMode(playerId, move);
        } else {
            processPlayerMode(playerId, move);
        }
    }

    private void processServerMode(String playerId, String move) {
        String serverMove = getRandomMove();
        String result = determineWinner(move, serverMove);

        GameDTO gameDTO = new GameDTO(0, playerId, "server", move, serverMove, result, LocalDateTime.now());
        gameService.saveGameResult(gameDTO);
        messagingTemplate.convertAndSend("/topic/result/" + playerId, gameDTO);
    }

    private void processPlayerMode(String playerId, String move) {
        if (opponentMap.containsKey(playerId)) {
            String opponent = opponentMap.get(playerId);
            gameMoves.put(playerId, move);

            if (gameMoves.containsKey(opponent)) {
                String opponentMove = gameMoves.remove(opponent);
                String result = determineWinner(move, opponentMove);
                String opponentResult = determineWinner(opponentMove, move);

                GameDTO playerGame = new GameDTO(0, playerId, opponent, move, opponentMove, result, LocalDateTime.now());
                GameDTO opponentGame = new GameDTO(0, opponent, playerId, opponentMove, move, opponentResult, LocalDateTime.now());

                gameService.saveGameResult(playerGame);
                gameService.saveGameResult(opponentGame);

                messagingTemplate.convertAndSend("/topic/result/" + playerId, playerGame);
                messagingTemplate.convertAndSend("/topic/result/" + opponent, opponentGame);

                // âœ… ê²Œì„ì´ ëë‚œ í›„ ë°ì´í„° ì‚­ì œ + ëŒ€ê¸°ì—´ë¡œ ìë™ ë³µê·€ ì•ˆ í•¨
                gameMoves.remove(playerId);
                gameMoves.remove(opponent);
                opponentMap.remove(playerId);
                opponentMap.remove(opponent);

                System.out.println("âœ… ê²Œì„ ì™„ë£Œ í›„ ë°ì´í„° ì‚­ì œ: " + playerId + " vs " + opponent);
            }
        } else {
            // âœ… í”Œë ˆì´ì–´ê°€ ì´ë¯¸ ëŒ€ê¸° ì¤‘ì¸ì§€ í™•ì¸ í›„, ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
            if (sessionManager.isInQueue(playerId)) {
                System.out.println("âš  " + playerId + "ëŠ” ì´ë¯¸ ëŒ€ê¸° ì¤‘...");
                return;
            }

            // âœ… ìƒˆë¡œìš´ ë§¤ì¹­ ìš”ì²­ (í”Œë ˆì´ì–´ê°€ ì§ì ‘ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ì‹¤í–‰)
            String opponent = sessionManager.findMatch(playerId);

            if (opponent == null) {
                sessionManager.addToMatchQueue(playerId);
                messagingTemplate.convertAndSend("/topic/match/" + playerId, "âŒ ìƒëŒ€ë°© ì—†ìŒ. ëŒ€ê¸° ì¤‘...");
                System.out.println("ğŸ• ëŒ€ê¸°ì—´ ì¶”ê°€ë¨: " + playerId);
            } else {
                opponentMap.put(playerId, opponent);
                opponentMap.put(opponent, playerId);
                messagingTemplate.convertAndSend("/topic/match/" + playerId, opponent);
                messagingTemplate.convertAndSend("/topic/match/" + opponent, playerId);
                System.out.println("âœ… ë§¤ì¹­ ì„±ê³µ: " + playerId + " vs " + opponent);
            }
        }
    }

    private String getRandomMove() {
        String[] moves = {"ê°€ìœ„", "ë°”ìœ„", "ë³´"};
        return moves[(int) (Math.random() * 3)];
    }

    private String determineWinner(String move1, String move2) {
        if (move1.equals(move2)) return "ë¬´ìŠ¹ë¶€";
        if ((move1.equals("ê°€ìœ„") && move2.equals("ë³´")) ||
            (move1.equals("ë°”ìœ„") && move2.equals("ê°€ìœ„")) ||
            (move1.equals("ë³´") && move2.equals("ë°”ìœ„"))) {
            return "ìŠ¹ë¦¬";
        }
        return "íŒ¨ë°°";
    }
}


package com.care.boot.game;

import java.util.List;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.PlayerStatsDTO;

@Mapper
public interface GameMapper {

    // ğŸ”¹ ê²Œì„ ê²°ê³¼ ì €ì¥ (game_history í…Œì´ë¸”)
    void insertGameResult(GameDTO gameDTO);

    // ğŸ”¹ íŠ¹ì • í”Œë ˆì´ì–´ì˜ ì „ì  ì¡°íšŒ (player_stats í…Œì´ë¸”)
    PlayerStatsDTO getPlayerStats(@Param("playerId") String playerId);

    // ğŸ”¹ ìƒˆë¡œìš´ í”Œë ˆì´ì–´ ì „ì  ì¶”ê°€ (ì´ˆê¸°í™”) â†’ ë°˜í™˜ê°’ ì¶”ê°€ (ì˜í–¥ ë°›ì€ í–‰ ìˆ˜)
    int createPlayerStats(@Param("playerId") String playerId);

    // ğŸ”¹ ê²Œì„ ê²°ê³¼ì— ë”°ë¼ ì „ì  ì—…ë°ì´íŠ¸ â†’ ë°˜í™˜ê°’ ì¶”ê°€ (ì˜í–¥ ë°›ì€ í–‰ ìˆ˜)
    int updatePlayerStats(@Param("playerId") String playerId, @Param("result") String result);

    // ğŸ”¹ ì „ì²´ ë­í‚¹ ì¡°íšŒ (ìŠ¹ë¦¬ ìˆœ ì •ë ¬)
    List<PlayerStatsDTO> getRanking();

    // ğŸ”¹ íŠ¹ì • í”Œë ˆì´ì–´ì˜ ê²Œì„ ê¸°ë¡ ì¡°íšŒ (game_history í…Œì´ë¸”)
    List<GameDTO> getGameHistory(@Param("playerId") String playerId);

    // ğŸ”¹ íŠ¹ì • ê²Œì„ IDì˜ ê¸°ë¡ ì‚­ì œ
    int deleteGameRecord(@Param("gameId") int gameId);
}



package com.care.boot.game;

import com.care.boot.gamedto.GameDTO;
import com.care.boot.gamedto.PlayerStatsDTO;
import org.springframework.stereotype.Service;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

@Service
public class GameService {

    private final GameMapper gameMapper;

    public GameService(GameMapper gameMapper) {
        this.gameMapper = gameMapper;
    }

    // ğŸ”¹ ê²Œì„ ê²°ê³¼ ì €ì¥ (DBì— ê¸°ë¡)
    public void saveGameResult(GameDTO gameDTO) {
        if (Objects.isNull(gameDTO.getPlayDate())) { // âœ… ë” ì§ê´€ì ì¸ null ì²´í¬
            gameDTO.setPlayDate(LocalDateTime.now());
        }

        gameMapper.insertGameResult(gameDTO);
        updatePlayerStats(gameDTO.getPlayer1Id(), gameDTO.getResult());
        updatePlayerStats(gameDTO.getPlayer2Id(), getOppositeResult(gameDTO.getResult()));
    }

    // ğŸ”¹ íŠ¹ì • í”Œë ˆì´ì–´ ì „ì  ì¡°íšŒ
    public PlayerStatsDTO getPlayerStats(String playerId) {
        return gameMapper.getPlayerStats(playerId);
    }

    // ğŸ”¹ ì „ì²´ ë­í‚¹ ì¡°íšŒ
    public List<PlayerStatsDTO> getRanking() {
        return gameMapper.getRanking();
    }

    // ğŸ”¹ íŠ¹ì • í”Œë ˆì´ì–´ì˜ ê²Œì„ ê¸°ë¡ ì¡°íšŒ
    public List<GameDTO> getGameHistory(String playerId) {
        return gameMapper.getGameHistory(playerId);
    }

    // ğŸ”¹ íŠ¹ì • ê²Œì„ ê¸°ë¡ ì‚­ì œ
    public boolean deleteGameRecord(int gameId) {
        return gameMapper.deleteGameRecord(gameId) > 0;
    }

    // ğŸ”¹ í”Œë ˆì´ì–´ ì „ì  ì—…ë°ì´íŠ¸ (ìŠ¹/íŒ¨/ë¬´ìŠ¹ë¶€ ë°˜ì˜)
    private void updatePlayerStats(String playerId, String result) {
        if (!"server".equals(playerId)) { // âœ… ì„œë²„ ê¸°ë¡ ì œì™¸
            Optional.ofNullable(gameMapper.getPlayerStats(playerId)) 
                    .orElseGet(() -> {
                        gameMapper.createPlayerStats(playerId);
                        return gameMapper.getPlayerStats(playerId); // âœ… ìƒì„± í›„ ë‹¤ì‹œ ì¡°íšŒ
                    });

            gameMapper.updatePlayerStats(playerId, result);
        }
    }

    // ğŸ”¹ ìƒëŒ€ë°©ì˜ ë°˜ëŒ€ ê²°ê³¼ ë°˜í™˜
    private String getOppositeResult(String result) {
        return switch (result) {
            case "ìŠ¹ë¦¬" -> "íŒ¨ë°°";
            case "íŒ¨ë°°" -> "ìŠ¹ë¦¬";
            default -> "ë¬´ìŠ¹ë¶€";
        };
    }
}


package com.care.boot.game;

import org.springframework.stereotype.Component;
import java.util.Iterator;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentLinkedQueue;

@Component
public class GameSessionManager {
    private final Set<String> onlinePlayers = ConcurrentHashMap.newKeySet();
    private final ConcurrentLinkedQueue<String> matchQueue = new ConcurrentLinkedQueue<>();

    public void addPlayer(String playerId) {
        onlinePlayers.add(playerId);
    }

    public void removePlayer(String playerId) {
        onlinePlayers.remove(playerId);
        matchQueue.remove(playerId);
    }

    public Set<String> getOnlinePlayers() {
        return Set.copyOf(onlinePlayers);
    }

    public void addToMatchQueue(String playerId) {
        if (!matchQueue.contains(playerId)) {
            matchQueue.add(playerId);
        }
    }

    public synchronized String findMatch(String playerId) {
        Iterator<String> iterator = matchQueue.iterator();
        while (iterator.hasNext()) {
            String opponent = iterator.next();
            if (!opponent.equals(playerId)) {
                iterator.remove();
                return opponent;
            }
        }
        return null;
    }

    // âœ… í”Œë ˆì´ì–´ê°€ ì´ë¯¸ ëŒ€ê¸° ì¤‘ì¸ì§€ í™•ì¸
    public boolean isInQueue(String playerId) {
        return matchQueue.contains(playerId);
    }
}



package com.care.boot.game;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;

@Controller
@RequestMapping("/game")  // ì»¨íŠ¸ë¡¤ëŸ¬ ê¸°ë³¸ ê²½ë¡œ ì„¤ì •
public class ViewController {

    @GetMapping("")
    public String showGamePage() {
        return "game";  // ë·° íŒŒì¼ì„ "WEB-INF/views/game/game.jsp"ë¡œ í†µì¼ ê°€ëŠ¥
    }
}



package com.care.boot.gamedto;

import com.fasterxml.jackson.annotation.JsonFormat;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;
import java.time.LocalDateTime;

public class GameDTO {
    @JsonProperty("gameId")
    private int gameId;

    @JsonProperty("player1Id")
    private String player1Id;

    @JsonProperty("player2Id")
    private String player2Id;

    @JsonProperty("player1Move")
    private String player1Move;

    @JsonProperty("player2Move")
    private String player2Move;

    @JsonProperty("result")
    private String result;

    @JsonProperty("playDate")
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss")  // âœ… JSON ë³€í™˜ ì‹œ í¬ë§· ì ìš©
    @JsonSerialize(using = LocalDateTimeSerializer.class)  // âœ… Jacksonì´ LocalDateTime ë³€í™˜í•˜ë„ë¡ ì„¤ì •
    private LocalDateTime playDate;

    // âœ… ê¸°ë³¸ ìƒì„±ì (JSON ë³€í™˜ ì‹œ í•„ìš”)
    public GameDTO() {}

    // âœ… ì „ì²´ í•„ë“œë¥¼ í¬í•¨í•˜ëŠ” ìƒì„±ì
    public GameDTO(int gameId, String player1Id, String player2Id, String player1Move, String player2Move, String result, LocalDateTime playDate) {
        this.gameId = gameId;
        this.player1Id = player1Id;
        this.player2Id = player2Id;
        this.player1Move = player1Move;
        this.player2Move = player2Move;
        this.result = result;
        this.playDate = playDate;
    }

    // âœ… JSON ì§ë ¬í™”ë¥¼ ìœ„í•œ Getter ì¶”ê°€
    public int getGameId() { return gameId; }
    public String getPlayer1Id() { return player1Id; }
    public String getPlayer2Id() { return player2Id; }
    public String getPlayer1Move() { return player1Move; }
    public String getPlayer2Move() { return player2Move; }
    public String getResult() { return result; }
    public LocalDateTime getPlayDate() { return playDate; }

    // âœ… JSON ì§ë ¬í™”ë¥¼ ìœ„í•œ Setter ì¶”ê°€
    public void setGameId(int gameId) { this.gameId = gameId; }
    public void setPlayer1Id(String player1Id) { this.player1Id = player1Id; }
    public void setPlayer2Id(String player2Id) { this.player2Id = player2Id; }
    public void setPlayer1Move(String player1Move) { this.player1Move = player1Move; }
    public void setPlayer2Move(String player2Move) { this.player2Move = player2Move; }
    public void setResult(String result) { this.result = result; }
    public void setPlayDate(LocalDateTime playDate) { this.playDate = playDate; }

    @Override
    public String toString() {
        return "GameDTO{" +
                "gameId=" + gameId +
                ", player1Id='" + player1Id + '\'' +
                ", player2Id='" + player2Id + '\'' +
                ", player1Move='" + player1Move + '\'' +
                ", player2Move='" + player2Move + '\'' +
                ", result='" + result + '\'' +
                ", playDate=" + playDate +
                '}';
    }
}



package com.care.boot.gamedto;

import com.fasterxml.jackson.annotation.JsonProperty;

public class GameRequest {
    @JsonProperty("playerId")
    private String playerId;

    @JsonProperty("move")
    private String move;

    @JsonProperty("mode")
    private String mode = "server";  // âœ… ê¸°ë³¸ê°’ ì„¤ì •

    @JsonProperty("opponent")  // âœ… ì¶”ê°€: ìƒëŒ€ í”Œë ˆì´ì–´ ID (ëœë¤ ë§¤ì¹­ or ì§ì ‘ ì„ íƒ)
    private String opponent;

    public GameRequest() {}

    public GameRequest(String playerId, String move, String mode, String opponent) {
        this.playerId = playerId;
        this.move = move;
        this.mode = (mode == null || mode.isEmpty()) ? "server" : mode;
        this.opponent = opponent;
    }

    public String getPlayerId() { return playerId; }
    public void setPlayerId(String playerId) { this.playerId = playerId; }

    public String getMove() { return move; }
    public void setMove(String move) { this.move = move; }

    public String getMode() { return mode; }
    public void setMode(String mode) { this.mode = (mode == null || mode.isEmpty()) ? "server" : mode; }

    public String getOpponent() { return opponent; }
    public void setOpponent(String opponent) { this.opponent = opponent; }

    @Override
    public String toString() {
        return "GameRequest{" +
                "playerId='" + playerId + '\'' +
                ", move='" + move + '\'' +
                ", mode='" + mode + '\'' +
                ", opponent='" + opponent + '\'' +
                '}';
    }
}


package com.care.boot.gamedto;

public class GameResult {
    private String playerId;   // í”Œë ˆì´ì–´ ID
    private String playerMove; // í”Œë ˆì´ì–´ ì„ íƒ
    private String opponentId; // ìƒëŒ€ë°© ID
    private String opponentMove; // ìƒëŒ€ë°© ì„ íƒ
    private String result;     // ê²°ê³¼ (ìŠ¹/íŒ¨/ë¬´ìŠ¹ë¶€)

    // ê¸°ë³¸ ìƒì„±ì (JSON ë³€í™˜ ì‹œ í•„ìš”)
    public GameResult() {}

    // ì „ì²´ í•„ë“œë¥¼ í¬í•¨í•˜ëŠ” ìƒì„±ì
    public GameResult(String playerId, String playerMove, String opponentId, String opponentMove, String result) {
        this.playerId = playerId;
        this.playerMove = playerMove;
        this.opponentId = opponentId;
        this.opponentMove = opponentMove;
        this.result = result;
    }

    // Getter & Setter
    public String getPlayerId() {
        return playerId;
    }

    public void setPlayerId(String playerId) {
        this.playerId = playerId;
    }

    public String getPlayerMove() {
        return playerMove;
    }

    public void setPlayerMove(String playerMove) {
        this.playerMove = playerMove;
    }

    public String getOpponentId() {
        return opponentId;
    }

    public void setOpponentId(String opponentId) {
        this.opponentId = opponentId;
    }

    public String getOpponentMove() {
        return opponentMove;
    }

    public void setOpponentMove(String opponentMove) {
        this.opponentMove = opponentMove;
    }

    public String getResult() {
        return result;
    }

    public void setResult(String result) {
        this.result = result;
    }

    @Override
    public String toString() {
        return "GameResult{" +
                "playerId='" + playerId + '\'' +
                ", playerMove='" + playerMove + '\'' +
                ", opponentId='" + opponentId + '\'' +
                ", opponentMove='" + opponentMove + '\'' +
                ", result='" + result + '\'' +
                '}';
    }
}



package com.care.boot.gamedto;

public class PlayerStatsDTO {
    private String playerId;   // í”Œë ˆì´ì–´ ID
    private int totalGames;    // ì´ ê²Œì„ ìˆ˜
    private int wins;          // ìŠ¹ë¦¬ ìˆ˜
    private int losses;        // íŒ¨ë°° ìˆ˜
    private int draws;         // ë¬´ìŠ¹ë¶€ ìˆ˜
    private double winRate;    // ìŠ¹ë¥ 

    // ê¸°ë³¸ ìƒì„±ì
    public PlayerStatsDTO() {}

    // ì „ì²´ í•„ë“œë¥¼ í¬í•¨í•˜ëŠ” ìƒì„±ì
    public PlayerStatsDTO(String playerId, int totalGames, int wins, int losses, int draws, double winRate) {
        this.playerId = playerId;
        this.totalGames = totalGames;
        this.wins = wins;
        this.losses = losses;
        this.draws = draws;
        this.winRate = winRate;
    }

    // Getter & Setter
    public String getPlayerId() {
        return playerId;
    }

    public void setPlayerId(String playerId) {
        this.playerId = playerId;
    }

    public int getTotalGames() {
        return totalGames;
    }

    public void setTotalGames(int totalGames) {
        this.totalGames = totalGames;
    }

    public int getWins() {
        return wins;
    }

    public void setWins(int wins) {
        this.wins = wins;
    }

    public int getLosses() {
        return losses;
    }

    public void setLosses(int losses) {
        this.losses = losses;
    }

    public int getDraws() {
        return draws;
    }

    public void setDraws(int draws) {
        this.draws = draws;
    }

    public double getWinRate() {
        return winRate;
    }

    public void setWinRate(double winRate) {
        this.winRate = winRate;
    }

    @Override
    public String toString() {
        return "PlayerStatsDTO{" +
                "playerId='" + playerId + '\'' +
                ", totalGames=" + totalGames +
                ", wins=" + wins +
                ", losses=" + losses +
                ", draws=" + draws +
                ", winRate=" + winRate +
                '}';
    }
}




